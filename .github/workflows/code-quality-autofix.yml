name: Code Quality Auto-Fix

on:
  push:
    branches:
      - '**'
    paths:
      - '**.py'
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - '**.py'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  autofix:
    name: Auto-fix Code Quality Issues
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install autopep8 flake8 black isort pylint bandit safety
      
      - name: Run auto-fix on all Python files
        id: autofix
        run: |
          # Find all Python files in the repository
          PYTHON_FILES=$(find . -name "*.py" -type f ! -path "./.git/*" ! -path "./venv/*" ! -path "./.venv/*")
          
          echo "Found Python files:"
          echo "$PYTHON_FILES"
          
          # Run autopep8 on all files
          for file in $PYTHON_FILES; do
            echo "Processing $file..."
            autopep8 --in-place --aggressive --aggressive "$file"
          done
          
          # Run isort to fix import order
          isort .
          
          # Optional: Run black for consistent formatting
          # black .
          
          # Check if there are any changes
          if [[ -n $(git status -s) ]]; then
            echo "changes_made=true" >> $GITHUB_OUTPUT
            echo "Files modified:"
            git status -s
          else
            echo "changes_made=false" >> $GITHUB_OUTPUT
            echo "No changes needed"
          fi
      
      - name: Run flake8 quality check
        id: flake8
        run: |
          echo "## Code Quality Report" > quality_report.md
          echo "" >> quality_report.md
          
          # Count issues before
          ISSUES_BEFORE=$(flake8 . --max-line-length=120 --count --statistics --exclude=.git,venv,.venv || true)
          echo "### Issues Found" >> quality_report.md
          echo '```' >> quality_report.md
          echo "$ISSUES_BEFORE" >> quality_report.md
          echo '```' >> quality_report.md
          
          # Save report
          cat quality_report.md
          
          # Set output
          ISSUE_COUNT=$(echo "$ISSUES_BEFORE" | tail -1)
          echo "issue_count=$ISSUE_COUNT" >> $GITHUB_OUTPUT
      
      - name: Run security scan
        id: security
        run: |
          echo "### Security Scan" >> quality_report.md
          
          # Bandit for security issues
          bandit -r . -f txt -o bandit_report.txt --exclude .git,venv,.venv || true
          
          if [ -s bandit_report.txt ]; then
            echo "Security issues found:"
            cat bandit_report.txt
            echo '```' >> quality_report.md
            cat bandit_report.txt >> quality_report.md
            echo '```' >> quality_report.md
          else
            echo "âœ… No security issues found" >> quality_report.md
          fi
      
      - name: Commit auto-fixes
        if: steps.autofix.outputs.changes_made == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add -A
          git commit -m "ðŸ¤– Auto-fix: Code quality improvements

          - Applied autopep8 formatting
          - Fixed import order with isort
          - Resolved PEP8 violations
          
          [skip ci]"
      
      - name: Push changes
        if: steps.autofix.outputs.changes_made == 'true' && github.event_name == 'push'
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref }}
      
      - name: Create PR comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('quality_report.md', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });
      
      - name: Upload quality report
        uses: actions/upload-artifact@v3
        with:
          name: quality-report
          path: quality_report.md
  
  metrics:
    name: Track Quality Metrics
    runs-on: ubuntu-latest
    needs: autofix
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install flake8 radon
      
      - name: Calculate metrics
        run: |
          mkdir -p .github/metrics
          
          # Code quality score
          ISSUES=$(flake8 . --max-line-length=120 --count --exclude=.git,venv,.venv || echo "0")
          
          # Complexity metrics
          radon cc . -a -j > .github/metrics/complexity.json || true
          radon mi . -j > .github/metrics/maintainability.json || true
          
          # Create metrics summary
          DATE=$(date +%Y-%m-%d)
          echo "{\"date\": \"$DATE\", \"issues\": \"$ISSUES\"}" > .github/metrics/quality_$DATE.json
          
          echo "Metrics collected for $DATE"
          cat .github/metrics/quality_$DATE.json
      
      - name: Commit metrics
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add .github/metrics/ || true
          git commit -m "ðŸ“Š Update code quality metrics [skip ci]" || echo "No metrics to commit"
          git push || echo "Nothing to push"
