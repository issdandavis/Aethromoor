name: AI Agent Responder

on:
  issue_comment:
    types: [created]

jobs:
  respond:
    if: >-
      startsWith(github.event.comment.body, '/ai') &&
      contains(fromJson('["COLLABORATOR","MEMBER","OWNER"]'), github.event.comment.author_association)
    permissions:
      issues: write
      pull-requests: write
      contents: read
    runs-on: ubuntu-latest
    steps:
      - name: Fail if OpenAI secret is missing
        run: |
          if [ -z "${{ secrets.OPENAI_API_KEY }}" ]; then
            echo "::error::Set an OPENAI_API_KEY secret to enable /ai replies." >&2
            exit 1
          fi

      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate reply via OpenAI
        id: chat
        uses: actions/github-script@v7
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        with:
          script: |
            const body = context.payload.comment?.body || '';
            const request = body.replace(/^\/ai\s*/i, '').trim() || 'Summarize the thread and propose next steps.';
            const issue = context.payload.issue;
            if (!issue?.number) {
              core.setFailed('No issue or pull request context available for this comment.');
              return;
            }

            const title = issue.title || '';
            const mainBody = issue.body || '';
            const url = issue.html_url || '';

            const prompt = [
              'You are the Avalon Ops Copilot. Answer concisely in Markdown.',
              'Stay within repository scope. If the user asks for code, describe the plan and files to touch, but do not invent secrets.',
              'If a request needs manual setup (secrets, app install), list the missing items explicitly.',
              `Thread title: ${title}`,
              `Thread body: ${mainBody}`,
              `Request: ${request}`,
              `Thread URL: ${url}`
            ].join('\n\n');

            const response = await fetch('https://api.openai.com/v1/chat/completions', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${process.env.OPENAI_API_KEY}`
              },
              body: JSON.stringify({
                model: 'gpt-4o-mini',
                messages: [
                  { role: 'system', content: 'You are a helpful GitHub project assistant. Keep answers short and actionable.' },
                  { role: 'user', content: prompt }
                ],
                temperature: 0.4,
                max_tokens: 500
              })
            });

            if (!response.ok) {
              const errorText = await response.text();
              core.setFailed(`OpenAI API error: ${response.status} ${errorText}`);
              return;
            }

            const data = await response.json();
            const reply = data.choices?.[0]?.message?.content?.trim();
            if (!reply) {
              core.setFailed('No reply generated by OpenAI.');
              return;
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: reply
            });
            core.setOutput('reply', reply);

      - name: Log generated reply
        run: echo "Reply posted:" ${{ steps.chat.outputs.reply }}
