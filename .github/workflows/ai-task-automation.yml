name: AI Task Automation

on:
  issues:
    types: [opened, labeled]
  issue_comment:
    types: [created]
  workflow_dispatch:

jobs:
  auto-label-issues:
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && github.event.action == 'opened'
    permissions:
      issues: write
    steps:
      - name: Auto-label based on content
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const title = issue.title.toLowerCase();
            const body = issue.body ? issue.body.toLowerCase() : '';
            const labels = [];
            
            // Content-based auto-labeling
            if (title.includes('bug') || body.includes('error') || body.includes('broken')) {
              labels.push('bug');
            }
            
            if (title.includes('lore') || body.includes('character') || body.includes('worldbuilding')) {
              labels.push('lore');
            }
            
            if (title.includes('choicescript') || title.includes('scene') || body.includes('expedition')) {
              labels.push('game-development');
            }
            
            if (title.includes('documentation') || title.includes('readme') || title.includes('guide')) {
              labels.push('documentation');
            }
            
            if (title.includes('ai') || title.includes('automation') || body.includes('copilot')) {
              labels.push('ai-automation');
            }
            
            // Priority detection
            if (title.includes('urgent') || title.includes('critical') || body.includes('high priority')) {
              labels.push('high-priority');
            }
            
            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: labels
              });
              
              console.log(`Added labels: ${labels.join(', ')}`);
            }

  ai-task-suggestions:
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && github.event.action == 'labeled'
    permissions:
      issues: write
    steps:
      - name: Suggest AI assistance
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const label = context.payload.label;
            
            let comment = '';
            
            // Provide AI-specific guidance based on label
            if (label.name === 'game-development') {
              comment = `ü§ñ **AI Assistant Available**
              
              This task involves game development. Consider using:
              
              - **Conversion Engineer AI**: For translating HTML scenes to ChoiceScript
              - **Structural Reviewer AI**: For ensuring scene parity and stat consistency
              
              Reference files:
              - Source: \`game/game.js\`
              - Target: \`choicescript_game/scenes/\`
              - Guide: \`.github/COPILOT_INSTRUCTIONS.md\`
              
              You can invoke the custom agent with: \`@copilot /agent my-agent\``;
            }
            
            if (label.name === 'lore') {
              comment = `üìö **Lore Curation Needed**
              
              This task involves lore management. Consider:
              
              - **Lore Curator AI**: Validates narrative consistency
              - Check against: \`lore/IZACK_MASTER_CHRONICLE_UPDATED.txt\`
              - Update shared context in: \`STATUS_CONTEXT.md\` (if exists)
              
              Key files:
              - \`lore/\` directory
              - Character chronicles
              - Magic system documentation`;
            }
            
            if (label.name === 'documentation') {
              comment = `üìù **Documentation Task**
              
              AI can help with:
              - Generating documentation from code
              - Updating roadmaps and guides
              - Creating consistent formatting
              
              Relevant files:
              - \`docs/PROJECT_ROADMAP.md\`
              - \`docs/NEXT_TASKS.md\`
              - \`docs/AUTOMATION_GUIDE.md\``;
            }
            
            if (comment) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: comment
              });
            }

  create-task-checklist:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'issue_comment' &&
      github.event.action == 'created' &&
      contains(github.event.comment.body, '/create-checklist')
    permissions:
      issues: write
    steps:
      - name: Generate AI-powered checklist
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            
            // Generate a task checklist based on issue type
            const checklist = `
            ## AI-Generated Task Checklist
            
            ### Planning
            - [ ] Review relevant documentation
            - [ ] Identify affected files
            - [ ] Check for dependencies
            
            ### Implementation
            - [ ] Make changes following repository patterns
            - [ ] Maintain consistency with existing code
            - [ ] Update related documentation
            
            ### Validation
            - [ ] Run automated validations
            - [ ] Test changes locally
            - [ ] Verify lore consistency (if applicable)
            - [ ] Check ChoiceScript syntax (if applicable)
            
            ### Finalization
            - [ ] Update NEXT_TASKS.md
            - [ ] Update PROJECT_ROADMAP.md if needed
            - [ ] Create pull request with detailed description
            
            ---
            *Generated by AI Task Automation*
            `;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: checklist
            });
