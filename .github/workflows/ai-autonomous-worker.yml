name: AI Autonomous Worker (Demo)

# This is a demonstration workflow for AI-driven autonomous development
# To activate: Add ANTHROPIC_API_KEY to repository secrets

on:
  # Run every 6 hours (adjust as needed)
  schedule:
    - cron: '0 */6 * * *'
  
  # Allow manual triggering
  workflow_dispatch:
    inputs:
      task_priority:
        description: 'Task priority to work on (1-5)'
        required: false
        default: '1'
        type: choice
        options:
          - '1'
          - '2'
          - '3'
          - '4'
          - '5'

jobs:
  autonomous-development:
    runs-on: ubuntu-latest
    
    # Only run if API key is configured
    if: ${{ secrets.ANTHROPIC_API_KEY != '' }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install anthropic GitPython
      
      - name: Configure Git
        run: |
          git config --global user.name "SpiralVerse AI Worker"
          git config --global user.email "ai-worker@spiralverse.dev"
      
      - name: Create or switch to AI work branch
        run: |
          git checkout ai-autonomous-work 2>/dev/null || git checkout -b ai-autonomous-work
      
      - name: Run AI Worker
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TASK_PRIORITY: ${{ github.event.inputs.task_priority || '1' }}
        run: |
          python .github/scripts/ai_autonomous_worker.py
      
      - name: Push changes if any
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            git push origin ai-autonomous-work --force-with-lease
            echo "âœ… AI worker pushed changes to ai-autonomous-work branch"
            echo "ðŸ“ Review changes and merge to main when ready"
          else
            echo "â„¹ï¸ No changes made by AI worker this run"
          fi
      
      - name: Create PR if needed
        if: github.event_name == 'schedule'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check if PR already exists
          PR_EXISTS=$(gh pr list --head ai-autonomous-work --json number --jq length)
          
          if [ "$PR_EXISTS" -eq 0 ] && [ -n "$(git log origin/main..ai-autonomous-work --oneline)" ]; then
            gh pr create \
              --title "[AI-AUTO] Autonomous development progress" \
              --body "This PR contains work completed by the autonomous AI worker. Please review before merging." \
              --base main \
              --head ai-autonomous-work \
              --label "ai-generated" \
              --label "needs-review"
            echo "âœ… Created PR for AI work"
          fi
      
      - name: Report status
        if: always()
        run: |
          echo "## AI Worker Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ai-autonomous-work" >> $GITHUB_STEP_SUMMARY
          echo "- **Priority:** P${{ github.event.inputs.task_priority || '1' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ -n $(git status --porcelain) ]]; then
            echo "âœ… Changes were made and committed" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ No changes in this run" >> $GITHUB_STEP_SUMMARY
          fi
