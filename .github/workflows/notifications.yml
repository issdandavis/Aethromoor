name: Notification System

on:
  push:
    branches:
      - main
  release:
    types: [published]
  issues:
    types: [opened, closed]
  pull_request:
    types: [opened, closed, merged]

permissions:
  contents: read
  issues: read
  pull-requests: read

jobs:
  notify-on-push:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Need previous commit to compare

      - name: Analyze changes
        id: analyze
        uses: actions/github-script@v7
        with:
          script: |
            const commit = context.payload.head_commit;
            
            // Get changed files
            const files = commit.added.concat(commit.modified).concat(commit.removed);
            
            // Categorize changes
            const categories = new Set();
            for (const file of files) {
              if (file.startsWith('game/') || file.startsWith('choicescript_game/')) {
                categories.add('ðŸŽ® Game Content');
              }
              if (file.startsWith('lore/') || file.startsWith('writing_drafts/')) {
                categories.add('ðŸ“– Lore/Writing');
              }
              if (file.startsWith('docs/')) {
                categories.add('ðŸ“š Documentation');
              }
              if (file.includes('.github/workflows/')) {
                categories.add('ðŸ¤– Automation');
              }
            }
            
            const categoriesText = Array.from(categories).join(', ') || 'ðŸ“ General Updates';
            
            return {
              message: commit.message,
              author: commit.author.name,
              url: commit.url,
              categories: categoriesText,
              filesCount: files.length
            };

      - name: Create summary
        run: |
          echo "## ðŸŽ‰ New Update Pushed to Avalon" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Changes:** ${{ fromJSON(steps.analyze.outputs.result).categories }}" >> $GITHUB_STEP_SUMMARY
          echo "**Files Changed:** ${{ fromJSON(steps.analyze.outputs.result).filesCount }}" >> $GITHUB_STEP_SUMMARY
          echo "**Author:** ${{ fromJSON(steps.analyze.outputs.result).author }}" >> $GITHUB_STEP_SUMMARY
          echo "**Message:** ${{ fromJSON(steps.analyze.outputs.result).message }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[View Commit](${{ fromJSON(steps.analyze.outputs.result).url }})" >> $GITHUB_STEP_SUMMARY

  notify-on-release:
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    steps:
      - name: Create release summary
        run: |
          echo "## ðŸš€ New Release Published!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ github.event.release.tag_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Name:** ${{ github.event.release.name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Release Notes" >> $GITHUB_STEP_SUMMARY
          echo "${{ github.event.release.body }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[View Release](${{ github.event.release.html_url }})" >> $GITHUB_STEP_SUMMARY

      # This is where you could add Discord webhook, email, or social media notifications
      # Example Discord webhook (requires DISCORD_WEBHOOK secret):
      # - name: Send Discord notification
      #   env:
      #     DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
      #   if: env.DISCORD_WEBHOOK != ''
      #   run: |
      #     curl -H "Content-Type: application/json" \
      #       -d "{\"content\": \"ðŸš€ **New Release:** ${{ github.event.release.tag_name }}\n${{ github.event.release.name }}\n\n[View Release](${{ github.event.release.html_url }})\"}" \
      #       $DISCORD_WEBHOOK

  notify-milestone-completion:
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && github.event.action == 'closed'
    steps:
      - name: Check if milestone completed
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            
            if (issue.milestone) {
              // Get milestone details
              const milestone = await github.rest.issues.getMilestone({
                owner: context.repo.owner,
                repo: context.repo.repo,
                milestone_number: issue.milestone.number
              });
              
              // Check if all issues in milestone are closed
              if (milestone.data.open_issues === 0) {
                core.summary
                  .addHeading('ðŸŽŠ Milestone Completed!', 2)
                  .addRaw(`**${milestone.data.title}** has been completed!`)
                  .addBreak()
                  .addRaw(`All ${milestone.data.closed_issues} issues have been resolved.`)
                  .addBreak()
                  .addLink('View Milestone', milestone.data.html_url)
                  .write();
              }
            }
