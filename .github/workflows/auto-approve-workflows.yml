name: Auto-Approve Trusted Account Workflows

# Automatically approves and enables workflow runs from all trusted accounts
# For personal accounts and organizations you own/manage

on:
  workflow_run:
    workflows: ["*"]
    types:
      - requested
  
  pull_request_target:
    types:
      - opened
      - synchronize
      - reopened

permissions:
  actions: write
  contents: write
  pull-requests: write
  checks: write

jobs:
  auto-approve:
    runs-on: ubuntu-latest
    if: github.event.pull_request.user.login == 'issdandavis' || github.actor == 'issdandavis' || github.event.workflow_run.actor.login == 'issdandavis'
    
    steps:
      - name: Auto-approve workflow runs from trusted accounts
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ”“ Auto-approving workflows for trusted account"
          
          # List of approved personal and organizational account usernames/emails
          # To add more accounts, see config/account-settings.json
          APPROVED_ACCOUNTS=(
            "issdandavis"
            "215328633+issdandavis@users.noreply.github.com"
          )
          
          ACTOR="${{ github.actor }}"
          
          # Check if actor is in approved list
          APPROVED=false
          for account in "${APPROVED_ACCOUNTS[@]}"; do
            if [[ "$ACTOR" == "$account" ]]; then
              APPROVED=true
              break
            fi
          done
          
          if [[ "$APPROVED" == "true" ]]; then
            echo "âœ… Account $ACTOR is approved for auto-workflow execution"
            echo "approved=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ Account $ACTOR is not in approved list"
            echo "approved=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Enable workflow runs for PRs
        if: github.event_name == 'pull_request_target'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          # Approve PR from trusted account
          gh pr review $PR_NUMBER --approve --body "âœ… Auto-approved: Trusted account workflow authorization"
          echo "âœ… PR #$PR_NUMBER auto-approved"
      
      - name: Set workflow approval status
        run: |
          echo "Trusted account auto-approval complete"
          echo "All workflows from approved accounts will run automatically"
