name: Security Scanning

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main", "develop" ]
  schedule:
    # Run weekly on Mondays at 00:00 UTC
    - cron: '0 0 * * 1'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  pull-requests: write

jobs:
  codeql-analysis:
    name: CodeQL Security Analysis
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        language: [ 'javascript' ]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
          queries: security-and-quality
      
      - name: Autobuild
        uses: github/codeql-action/autobuild@v3
      
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{matrix.language}}"

  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: moderate
          comment-summary-in-pr: true

  secret-scanning:
    name: Secret Scanning
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: TruffleHog OSS
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug --only-verified

  file-validation:
    name: Validate Repository Files
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Check for sensitive files
        run: |
          echo "Checking for sensitive files that shouldn't be committed..."
          
          # Check for common sensitive file patterns
          SENSITIVE_FILES=$(find . -type f \( \
            -name "*.env" ! -name "*.env.example" \
            -o -name "*.key" \
            -o -name "*.pem" \
            -o -name "*.p12" \
            -o -name "*.pfx" \
            -o -name "*secret*" ! -name "SECRET*" \
            -o -name "*password*" ! -path "*/node_modules/*" \
            -o -name "credentials.json" \
            -o -name "id_rsa" \
            \) 2>/dev/null || true)
          
          if [ -n "$SENSITIVE_FILES" ]; then
            echo "⚠️ WARNING: Found potentially sensitive files:"
            echo "$SENSITIVE_FILES"
            echo ""
            echo "Please verify these files should be committed."
            echo "Consider adding them to .gitignore if they contain secrets."
            # Don't fail, just warn
          else
            echo "✅ No obvious sensitive files detected"
          fi
      
      - name: Validate .gitignore
        run: |
          echo "Checking .gitignore configuration..."
          
          if [ -f .gitignore ]; then
            # Check for common patterns
            PATTERNS=("*.env" "*.key" "node_modules" "*.log")
            MISSING=()
            
            for pattern in "${PATTERNS[@]}"; do
              if ! grep -q "$pattern" .gitignore; then
                MISSING+=("$pattern")
              fi
            done
            
            if [ ${#MISSING[@]} -gt 0 ]; then
              echo "ℹ️ Consider adding these patterns to .gitignore:"
              printf '%s\n' "${MISSING[@]}"
            else
              echo "✅ .gitignore looks good"
            fi
          else
            echo "⚠️ No .gitignore file found"
          fi

  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [codeql-analysis, file-validation]
    if: always()
    
    steps:
      - name: Create summary
        run: |
          echo "# Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ Security scans completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Checks performed:**" >> $GITHUB_STEP_SUMMARY
          echo "- CodeQL Analysis (JavaScript)" >> $GITHUB_STEP_SUMMARY
          echo "- Secret Scanning (TruffleHog)" >> $GITHUB_STEP_SUMMARY
          echo "- File Validation" >> $GITHUB_STEP_SUMMARY
          echo "- Dependency Review (on PRs)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the Actions tab for detailed results." >> $GITHUB_STEP_SUMMARY
