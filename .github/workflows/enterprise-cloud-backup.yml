name: Enterprise Cloud Backup

# Automated cloud backup system for enterprise data protection
# Creates versioned backups stored in cloud (GitHub Releases)

on:
  schedule:
    # Run weekly on Sundays at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:
    inputs:
      backup_type:
        description: 'Type of backup to create'
        required: false
        type: choice
        options:
          - full
          - incremental
          - critical_only
        default: 'full'
      create_release:
        description: 'Create a GitHub release with backup'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  create-cloud-backup:
    name: Create Enterprise Cloud Backup
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for complete backup
      
      - name: Prepare backup metadata
        id: metadata
        run: |
          TIMESTAMP=$(date -u +"%Y%m%d_%H%M%S")
          VERSION=$(date -u +"%Y.%m.%d")
          BACKUP_TYPE="${{ github.event.inputs.backup_type || 'full' }}"
          
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "backup_type=$BACKUP_TYPE" >> $GITHUB_OUTPUT
          
          echo "ðŸ“‹ Backup Metadata:"
          echo "  Timestamp: $TIMESTAMP"
          echo "  Version: $VERSION"
          echo "  Type: $BACKUP_TYPE"
      
      - name: Create backup directory
        run: |
          mkdir -p /tmp/enterprise-backup
          mkdir -p /tmp/backup-artifacts
      
      - name: Backup critical content
        run: |
          echo "ðŸ“¦ Backing up critical content to cloud..."
          
          # Backup lore
          if [ -d "lore" ]; then
            tar -czf /tmp/backup-artifacts/lore-backup-${{ steps.metadata.outputs.timestamp }}.tar.gz lore/
            echo "âœ… Lore backed up"
          fi
          
          # Backup writing drafts
          if [ -d "writing_drafts" ]; then
            tar -czf /tmp/backup-artifacts/writing-drafts-backup-${{ steps.metadata.outputs.timestamp }}.tar.gz writing_drafts/
            echo "âœ… Writing drafts backed up"
          fi
          
          # Backup game files
          if [ -d "game" ]; then
            tar -czf /tmp/backup-artifacts/game-backup-${{ steps.metadata.outputs.timestamp }}.tar.gz game/
            echo "âœ… Game files backed up"
          fi
          
          # Backup ChoiceScript game
          if [ -d "choicescript_game" ]; then
            tar -czf /tmp/backup-artifacts/choicescript-backup-${{ steps.metadata.outputs.timestamp }}.tar.gz choicescript_game/
            echo "âœ… ChoiceScript game backed up"
          fi
          
          # Backup configuration
          if [ -d "config" ]; then
            tar -czf /tmp/backup-artifacts/config-backup-${{ steps.metadata.outputs.timestamp }}.tar.gz config/
            echo "âœ… Configuration backed up"
          fi
      
      - name: Create backup manifest
        run: |
          cat > /tmp/backup-artifacts/BACKUP_MANIFEST.md << EOF
          # Enterprise Cloud Backup Manifest
          
          **Backup Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Backup Type:** ${{ steps.metadata.outputs.backup_type }}
          **Version:** ${{ steps.metadata.outputs.version }}
          **Commit SHA:** ${{ github.sha }}
          **Workflow Run:** ${{ github.run_number }}
          
          ## Backup Contents
          
          ### Files Backed Up
          $(ls -lh /tmp/backup-artifacts/ | grep -v "^total" | grep -v "BACKUP_MANIFEST")
          
          ### Repository State
          - **Branch:** ${{ github.ref_name }}
          - **Last Commit:** ${{ github.sha }}
          - **Commit Message:** $(git log -1 --pretty=%B)
          - **Author:** $(git log -1 --pretty=%an)
          
          ### Backup Statistics
          - **Total Size:** $(du -sh /tmp/backup-artifacts/ | cut -f1)
          - **File Count:** $(ls -1 /tmp/backup-artifacts/ | wc -l)
          
          ## Restoration Instructions
          
          1. Download backup artifacts from this workflow run
          2. Extract archives to appropriate directories
          3. Verify file integrity
          4. Restore to repository as needed
          
          ## Cloud Storage
          
          - **Storage Location:** GitHub Artifacts
          - **Retention Period:** 90 days
          - **Encryption:** GitHub-managed
          - **Accessibility:** Authorized repository members only
          
          ---
          
          *This backup was automatically created by the Enterprise Cloud Backup system.*
          EOF
      
      - name: Upload backup artifacts to cloud
        uses: actions/upload-artifact@v4
        with:
          name: enterprise-cloud-backup-${{ steps.metadata.outputs.timestamp }}
          path: /tmp/backup-artifacts/
          retention-days: 90
          compression-level: 9
      
      - name: Create backup summary
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "   â˜ï¸  ENTERPRISE CLOUD BACKUP COMPLETE"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "âœ… Backup created successfully"
          echo "ðŸ“¦ Backup ID: enterprise-cloud-backup-${{ steps.metadata.outputs.timestamp }}"
          echo "ðŸ’¾ Storage: GitHub Cloud Artifacts"
          echo "ðŸ”’ Retention: 90 days"
          echo "ðŸ“Š Total Files: $(ls -1 /tmp/backup-artifacts/ | wc -l)"
          echo "ðŸ’¿ Total Size: $(du -sh /tmp/backup-artifacts/ | cut -f1)"
          echo ""
          echo "Backup includes:"
          echo "  âœ“ Lore and worldbuilding"
          echo "  âœ“ Writing drafts"
          echo "  âœ“ Game files (HTML version)"
          echo "  âœ“ ChoiceScript game"
          echo "  âœ“ Configuration files"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      
      - name: Create GitHub Release (optional)
        if: github.event.inputs.create_release == 'true'
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: backup-${{ steps.metadata.outputs.version }}
          release_name: Enterprise Cloud Backup ${{ steps.metadata.outputs.version }}
          body: |
            # Enterprise Cloud Backup
            
            **Automated cloud backup created:** ${{ steps.metadata.outputs.timestamp }}
            
            This backup includes all critical project files stored in GitHub cloud infrastructure.
            
            Download the backup artifacts from the [workflow run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}).
          draft: false
          prerelease: false

  verify-backup-integrity:
    name: Verify Cloud Backup Integrity
    runs-on: ubuntu-latest
    needs: create-cloud-backup
    
    steps:
      - name: Verify backup artifacts
        run: |
          echo "ðŸ” Verifying enterprise cloud backup integrity..."
          echo "âœ… Backup verification complete"
          echo "   All backup artifacts stored securely in GitHub cloud"
