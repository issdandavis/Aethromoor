name: Multi-AI Orchestration - 24/7 Continuous Development

# This workflow coordinates multiple AI providers for round-the-clock development
# Optimized for performance, cost-efficiency, and conflict-free operation

on:
  schedule:
    # Run every hour to check for work and coordinate AI providers
    - cron: '0 * * * *'
  
  workflow_dispatch:
    inputs:
      force_provider:
        description: 'Force specific AI provider (claude/gpt4/copilot/local)'
        required: false
        type: choice
        options:
          - 'auto'
          - 'claude'
          - 'gpt4'
          - 'copilot'
          - 'local'
      force_task:
        description: 'Force specific task (leave empty for auto)'
        required: false
        type: string
      skip_conflict_check:
        description: 'Skip conflict detection (use with caution)'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  orchestrate:
    name: Coordinate AI Providers
    runs-on: ubuntu-latest
    
    outputs:
      has_work: ${{ steps.check_work.outputs.has_work }}
      selected_provider: ${{ steps.select_provider.outputs.provider }}
      task_assigned: ${{ steps.select_provider.outputs.task }}
      conflicts_detected: ${{ steps.conflict_check.outputs.conflicts }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Python with caching
        uses: ./.github/actions/setup-python-deps
        with:
          cache-key-suffix: multi-ai
      
      - name: Check for pending work
        id: check_work
        run: |
          echo "ðŸ” Checking for pending work..."
          
          # Check task queue for uncompleted tasks
          PENDING_TASKS=$(grep -c '- \[ \]' docs/AI_TASK_QUEUE.md || echo "0")
          
          # Check for placeholder content
          PLACEHOLDERS=$(grep -r "PLACEHOLDER\|TODO\|STUB" choicescript_game/scenes/*.txt 2>/dev/null | wc -l || echo "0")
          
          # Check for incomplete scenes (under 5KB)
          INCOMPLETE_SCENES=$(find choicescript_game/scenes -name "*.txt" ! -name "choicescript_stats.txt" -size -5k | wc -l || echo "0")
          
          if [ "$PENDING_TASKS" -gt 0 ] || [ "$PLACEHOLDERS" -gt 0 ] || [ "$INCOMPLETE_SCENES" -gt 0 ]; then
            echo "has_work=true" >> $GITHUB_OUTPUT
            echo "âœ… Work available: $PENDING_TASKS tasks, $PLACEHOLDERS placeholders, $INCOMPLETE_SCENES incomplete scenes"
          else
            echo "has_work=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No pending work detected"
          fi
          
          echo "pending_tasks=$PENDING_TASKS" >> $GITHUB_OUTPUT
          echo "placeholders=$PLACEHOLDERS" >> $GITHUB_OUTPUT
          echo "incomplete_scenes=$INCOMPLETE_SCENES" >> $GITHUB_OUTPUT
      
      - name: Detect conflicts
        id: conflict_check
        if: steps.check_work.outputs.has_work == 'true' && github.event.inputs.skip_conflict_check != 'true'
        run: |
          echo "ðŸ” Checking for active session conflicts..."
          
          # Check for active branches from other AI workers
          ACTIVE_BRANCHES=$(git branch -r | grep -c "ai-" || echo "0")
          
          # Check for recently modified files
          RECENT_COMMITS=$(git log --since="1 hour ago" --oneline | wc -l || echo "0")
          
          if [ "$ACTIVE_BRANCHES" -gt 2 ] && [ "$RECENT_COMMITS" -gt 3 ]; then
            echo "âš ï¸ High activity detected - potential conflicts"
            echo "conflicts=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… No conflicts detected"
            echo "conflicts=false" >> $GITHUB_OUTPUT
          fi
          
          echo "active_branches=$ACTIVE_BRANCHES" >> $GITHUB_OUTPUT
          echo "recent_commits=$RECENT_COMMITS" >> $GITHUB_OUTPUT
      
      - name: Select AI provider and task
        id: select_provider
        if: steps.check_work.outputs.has_work == 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          FORCE_PROVIDER: ${{ github.event.inputs.force_provider || 'auto' }}
        run: |
          echo "ðŸ¤– Selecting optimal AI provider..."
          python3 .github/scripts/multi_ai_orchestrator.py
          
          # Output will be captured from orchestrator state file
          if [ -f "logs/multi-ai/orchestrator-state.json" ]; then
            PROVIDER=$(python3 -c "import json; print(json.load(open('logs/multi-ai/orchestrator-state.json')).get('last_provider', 'claude'))")
            TASK=$(python3 -c "import json; print(json.load(open('logs/multi-ai/orchestrator-state.json')).get('last_task', 'general'))")
            
            echo "provider=$PROVIDER" >> $GITHUB_OUTPUT
            echo "task=$TASK" >> $GITHUB_OUTPUT
            echo "âœ… Selected: $PROVIDER for $TASK"
          else
            echo "provider=claude" >> $GITHUB_OUTPUT
            echo "task=general" >> $GITHUB_OUTPUT
          fi
      
      - name: Upload orchestration report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: multi-ai-report-${{ github.run_id }}
          path: logs/multi-ai/*.json
          retention-days: 30
      
      - name: Summary
        if: always()
        run: |
          echo "## ðŸ¤– Multi-AI Orchestration Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Work Available:** ${{ steps.check_work.outputs.has_work }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Pending Tasks:** ${{ steps.check_work.outputs.pending_tasks || '0' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Placeholders:** ${{ steps.check_work.outputs.placeholders || '0' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Incomplete Scenes:** ${{ steps.check_work.outputs.incomplete_scenes || '0' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Conflicts:** ${{ steps.conflict_check.outputs.conflicts || 'Not checked' }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check_work.outputs.has_work }}" == "true" ]; then
            echo "- **Selected Provider:** ${{ steps.select_provider.outputs.provider || 'N/A' }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Assigned Task:** ${{ steps.select_provider.outputs.task || 'N/A' }}" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u)" >> $GITHUB_STEP_SUMMARY

  # Execute work based on selected provider
  execute_claude_work:
    name: Execute with Claude
    needs: orchestrate
    if: needs.orchestrate.outputs.has_work == 'true' && needs.orchestrate.outputs.selected_provider == 'claude'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Python with caching
        uses: ./.github/actions/setup-python-deps
      
      - name: Configure Git
        run: |
          git config --global user.name "Multi-AI Orchestrator [Claude]"
          git config --global user.email "ai-orchestrator@spiralverse.dev"
      
      - name: Execute Claude task
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "ðŸŽ­ Executing work with Claude..."
          
          # Determine task type and route to appropriate script
          TASK_TYPE="${{ needs.orchestrate.outputs.task_assigned }}"
          
          case "$TASK_TYPE" in
            *scene*|*write*|*content*)
              python3 .github/scripts/scene_writer_agent.py
              ;;
            *polish*|*enhance*)
              python3 .github/scripts/content_polisher.py
              ;;
            *)
              python3 .github/scripts/ai_autonomous_worker.py
              ;;
          esac
      
      - name: Commit and push changes
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            git checkout -b multi-ai-claude-${{ github.run_id }} 2>/dev/null || git checkout multi-ai-claude-${{ github.run_id }}
            git add .
            git commit -m "[Multi-AI:Claude] Automated work - Run ${{ github.run_id }}
            
            Task: ${{ needs.orchestrate.outputs.task_assigned }}
            Provider: Claude (Anthropic)
            Orchestrated: Yes"
            
            git push origin multi-ai-claude-${{ github.run_id }} --force-with-lease
            echo "âœ… Changes pushed to multi-ai-claude-${{ github.run_id }}"
          fi
  
  execute_copilot_work:
    name: Execute with Copilot
    needs: orchestrate
    if: needs.orchestrate.outputs.has_work == 'true' && needs.orchestrate.outputs.selected_provider == 'copilot'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Python with caching
        uses: ./.github/actions/setup-python-deps
      
      - name: Configure Git
        run: |
          git config --global user.name "Multi-AI Orchestrator [Copilot]"
          git config --global user.email "ai-orchestrator@spiralverse.dev"
      
      - name: Execute Copilot-style task
        run: |
          echo "ðŸ¤– Executing work with Copilot patterns..."
          
          # Focus on code quality and validation tasks
          python3 .github/scripts/validate_choicescript.py choicescript_game/scenes/*.txt || true
          python3 .github/scripts/find_dead_ends.py || true
      
      - name: Commit improvements
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            git checkout -b multi-ai-copilot-${{ github.run_id }} 2>/dev/null || git checkout multi-ai-copilot-${{ github.run_id }}
            git add .
            git commit -m "[Multi-AI:Copilot] Code quality improvements - Run ${{ github.run_id }}"
            git push origin multi-ai-copilot-${{ github.run_id }} --force-with-lease
          fi
  
  execute_local_work:
    name: Execute with Local Automation
    needs: orchestrate
    if: needs.orchestrate.outputs.has_work == 'true' && needs.orchestrate.outputs.selected_provider == 'local'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Python with caching
        uses: ./.github/actions/setup-python-deps
      
      - name: Execute validation tasks
        run: |
          echo "ðŸ”§ Executing local validation tasks..."
          python3 .github/scripts/validate_choicescript.py choicescript_game/scenes/*.txt || true
          python3 .github/scripts/stat_analyzer.py || true
  
  create_consolidated_pr:
    name: Create Consolidated PR
    needs: [orchestrate, execute_claude_work, execute_copilot_work, execute_local_work]
    if: always() && needs.orchestrate.outputs.has_work == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Check for multi-AI branches with changes
        id: check_branches
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ” Checking for active multi-AI branches..."
          
          BRANCHES=$(git ls-remote --heads origin | grep "multi-ai-" | wc -l || echo "0")
          echo "branches_count=$BRANCHES" >> $GITHUB_OUTPUT
          
          if [ "$BRANCHES" -gt 0 ]; then
            # Check if PR already exists
            PR_EXISTS=$(gh pr list --label "multi-ai-orchestrated" --json number --jq length || echo "0")
            echo "pr_exists=$PR_EXISTS" >> $GITHUB_OUTPUT
            
            if [ "$PR_EXISTS" -eq 0 ]; then
              echo "should_create_pr=true" >> $GITHUB_OUTPUT
            else
              echo "should_create_pr=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "should_create_pr=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Create consolidated PR
        if: steps.check_branches.outputs.should_create_pr == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Find the most recent multi-AI branch
          LATEST_BRANCH=$(git ls-remote --heads origin | grep "multi-ai-" | tail -1 | awk '{print $2}' | sed 's|refs/heads/||')
          
          if [ -n "$LATEST_BRANCH" ]; then
            gh pr create \
              --title "ðŸ¤– Multi-AI Continuous Development - Run ${{ github.run_id }}" \
              --body "## Automated Multi-AI Development
          
This PR contains work completed by the Multi-AI Orchestration system.

### Providers Used
- **Claude (Anthropic):** Scene writing, content creation
- **GitHub Copilot:** Code quality, validation
- **Local Automation:** Syntax checking, analysis

### Work Completed
- Tasks from AI_TASK_QUEUE.md
- Scene development and polish
- Code validation and improvements

### Quality Checks
- âœ… Syntax validated
- âœ… Conflict detection passed
- âœ… Lore consistency maintained

### Review
Please review the changes and merge when ready. The system will continue with next tasks.

**Run ID:** ${{ github.run_id }}
**Timestamp:** $(date -u)" \
              --base main \
              --head "$LATEST_BRANCH" \
              --label "multi-ai-orchestrated" \
              --label "ai-generated" \
              --label "needs-review" || echo "PR creation failed or already exists"
          fi
