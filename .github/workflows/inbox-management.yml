name: AI Inbox Management System

# Automated inbox management for GitHub notifications and email
# Handles categorization, sorting, prioritization across all connected accounts
# Auto-replies are DISABLED to reduce notification spam

on:
  issues:
    types: [opened, labeled, assigned]
  issue_comment:
    types: [created]
  pull_request:
    types: [opened, review_requested, assigned]
  pull_request_review_comment:
    types: [created]
  discussion:
    types: [created, answered, labeled]
  discussion_comment:
    types: [created]
  schedule:
    # Process inbox every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      force_reply:
        description: 'Force send auto-replies even if already sent'
        required: false
        type: boolean
        default: false

permissions:
  issues: write
  pull-requests: write
  discussions: write
  contents: read

jobs:
  categorize-and-respond:
    name: Categorize & Auto-Respond
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: Categorize GitHub notification
        id: categorize
        uses: actions/github-script@v7
        with:
          script: |
            const { context } = require('@actions/github');

            // Categorization logic
            let category = 'general';
            let priority = 'medium';
            let shouldAutoReply = false; // Disabled to reduce notifications
            let replyMessage = '';

            // Determine notification type and category
            if (context.eventName === 'issues') {
              category = 'issue';
              priority = 'high';
              // shouldAutoReply = true; // DISABLED: Auto-replies disabled to reduce spam

              const issue = context.payload.issue;
              const labels = issue.labels.map(l => l.name);

              // Prioritize based on labels
              if (labels.includes('bug')) {
                category = 'bug-report';
                // Check for critical indicators
                if (labels.includes('security') || issue.title.toLowerCase().includes('security') ||
                    issue.title.toLowerCase().includes('crash') || labels.includes('critical')) {
                  priority = 'critical';
                } else {
                  priority = 'high';
                }
              } else if (labels.includes('enhancement')) {
                category = 'feature-request';
              } else if (labels.includes('question')) {
                category = 'question';
                priority = 'medium';
              }

              // Auto-reply message for issues
              replyMessage = "Thank you for opening this issue! ðŸ¤–\n\n" +
                "**Automated Response:**\n" +
                "- This issue has been categorized as: **" + category + "**\n" +
                "- Priority level: **" + priority + "**\n" +
                "- An AI agent will review this within 24 hours\n\n" +
                "**What happens next:**\n" +
                "1. Our automated systems will validate the issue\n" +
                "2. Appropriate labels and assignments will be added\n" +
                "3. A team member will respond with next steps\n\n" +
                "For urgent matters, please mention @issdandavis in your comment.\n\n" +
                "---\n" +
                "*This is an automated response from the Avalon AI Inbox Management System*";
            }
            else if (context.eventName === 'pull_request') {
              category = 'pull-request';
              priority = 'high';
              // shouldAutoReply = true; // DISABLED: Auto-replies disabled to reduce spam

              replyMessage = "Thank you for your pull request! ðŸŽ‰\n\n" +
                "**Automated PR Processing:**\n" +
                "- Automated checks will run shortly\n" +
                "- Code review will be scheduled\n" +
                "- Expected review time: 24-48 hours\n\n" +
                "**Before your PR is merged:**\n" +
                "- [ ] All automated tests must pass\n" +
                "- [ ] Code review must be approved\n" +
                "- [ ] Documentation updates (if applicable)\n\n" +
                "We appreciate your contribution to the Avalon project!\n\n" +
                "---\n" +
                "*This is an automated response from the Avalon AI Inbox Management System*";
            }
            else if (context.eventName === 'discussion') {
              category = 'discussion';
              priority = 'low';
              // shouldAutoReply = true; // DISABLED: Auto-replies disabled to reduce spam

              replyMessage = "Thanks for starting this discussion! ðŸ’¬\n\n" +
                "**Automated Discussion Handling:**\n" +
                "- This discussion will be monitored by our AI systems\n" +
                "- Community members and maintainers will be notified\n" +
                "- Response time: 1-3 days\n\n" +
                "**Helpful Resources:**\n" +
                "- [Documentation](docs/)\n" +
                "- [Contributing Guide](CONTRIBUTING.md)\n" +
                "- [Project Roadmap](docs/PROJECT_ROADMAP.md)\n\n" +
                "---\n" +
                "*This is an automated response from the Avalon AI Inbox Management System*";
            }

            // Set outputs
            core.setOutput('category', category);
            core.setOutput('priority', priority);
            core.setOutput('should_auto_reply', shouldAutoReply);
            core.setOutput('reply_message', replyMessage);

            console.log(`Categorized as: ${category} (Priority: ${priority})`);
            return { category, priority, shouldAutoReply };

      - name: Send auto-reply
        if: steps.categorize.outputs.should_auto_reply == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const replyMessage = process.env.REPLY_MESSAGE;

            try {
              if (context.eventName === 'issues' && context.payload.action === 'opened') {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.payload.issue.number,
                  body: replyMessage
                });
                console.log('Auto-reply sent to issue');
              }
              else if (context.eventName === 'pull_request' && context.payload.action === 'opened') {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.payload.pull_request.number,
                  body: replyMessage
                });
                console.log('Auto-reply sent to pull request');
              }
              else if (context.eventName === 'discussion' && context.payload.action === 'created') {
                // Discussion comments require GraphQL
                console.log('Discussion auto-reply would be sent via GraphQL API');
              }
            } catch (error) {
              console.log('Auto-reply skipped or already sent:', error.message);
            }
        env:
          REPLY_MESSAGE: ${{ steps.categorize.outputs.reply_message }}

      - name: Apply smart labels
        uses: actions/github-script@v7
        if: github.event_name == 'issues' || github.event_name == 'pull_request'
        with:
          script: |
            const category = process.env.CATEGORY;
            const priority = process.env.PRIORITY;

            const labelsToAdd = [];

            // Category labels
            if (category === 'bug-report') labelsToAdd.push('bug');
            if (category === 'feature-request') labelsToAdd.push('enhancement');
            if (category === 'question') labelsToAdd.push('question');

            // Priority labels
            if (priority === 'critical') labelsToAdd.push('priority:critical');
            if (priority === 'high') labelsToAdd.push('priority:high');

            // Add automated label
            labelsToAdd.push('automated:inbox-managed');

            if (labelsToAdd.length > 0) {
              const issueNumber = context.payload.issue?.number || context.payload.pull_request?.number;

              if (issueNumber) {
                try {
                  await github.rest.issues.addLabels({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issueNumber,
                    labels: labelsToAdd
                  });
                  console.log('Applied labels: ' + labelsToAdd.join(', '));
                } catch (error) {
                  console.log('Some labels may not exist:', error.message);
                }
              }
            }
        env:
          CATEGORY: ${{ steps.categorize.outputs.category }}
          PRIORITY: ${{ steps.categorize.outputs.priority }}

      - name: Update project board
        uses: actions/github-script@v7
        continue-on-error: true
        if: github.event_name == 'issues' || github.event_name == 'pull_request'
        with:
          script: |
            console.log('Project board integration would be configured here');
            console.log('This requires GitHub Projects API v2 setup');

  process-scheduled-inbox:
    name: Process Scheduled Inbox Review
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: Generate inbox summary
        id: summary
        uses: actions/github-script@v7
        with:
          script: |
            const { context } = require('@actions/github');

            // Get all open issues and PRs
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });

            // Categorize items
            const categories = {
              bugs: [],
              features: [],
              questions: [],
              prs: [],
              needsResponse: [],
              stale: []
            };

            const now = new Date();
            const oneDayAgo = new Date(now - 24 * 60 * 60 * 1000);
            const sevenDaysAgo = new Date(now - 7 * 24 * 60 * 60 * 1000);

            for (const item of issues.data) {
              const labels = item.labels.map(l => l.name);
              const updatedAt = new Date(item.updated_at);

              if (item.pull_request) {
                categories.prs.push(item);
              } else {
                if (labels.includes('bug')) categories.bugs.push(item);
                if (labels.includes('enhancement')) categories.features.push(item);
                if (labels.includes('question')) categories.questions.push(item);

                // Check if needs response
                if (item.comments === 0 && updatedAt < oneDayAgo) {
                  categories.needsResponse.push(item);
                }

                // Check if stale
                if (updatedAt < sevenDaysAgo) {
                  categories.stale.push(item);
                }
              }
            }

            // Generate summary
            const summary = `# Inbox Summary - ${now.toISOString().split('T')[0]}

            ## Overview
            - Total Open Items: ${issues.data.length}
            - Open Issues: ${issues.data.filter(i => !i.pull_request).length}
            - Open PRs: ${categories.prs.length}

            ## By Category
            - Bugs: ${categories.bugs.length}
            - Feature Requests: ${categories.features.length}
            - Questions: ${categories.questions.length}

            ## Action Required
            - Needs Response: ${categories.needsResponse.length}
            - Stale Items (>7 days): ${categories.stale.length}

            ## Details
            ${categories.needsResponse.length > 0 ? '\n### Needs Response:\n' + categories.needsResponse.map(i => `- #${i.number}: ${i.title}`).join('\n') : ''}
            ${categories.stale.length > 0 ? '\n### Stale Items:\n' + categories.stale.map(i => `- #${i.number}: ${i.title} (updated ${i.updated_at})`).join('\n') : ''}

            ---
            *Generated by Avalon AI Inbox Management System*
            `;

            console.log(summary);

            // Save summary
            const fs = require('fs');
            fs.writeFileSync('/tmp/inbox_summary.md', summary);

            return {
              total: issues.data.length,
              needsResponse: categories.needsResponse.length,
              stale: categories.stale.length
            };

      - name: Upload inbox summary
        uses: actions/upload-artifact@v4
        with:
          name: inbox-summary-${{ github.run_number }}
          path: /tmp/inbox_summary.md
          retention-days: 30

      - name: Check for items needing attention
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('/tmp/inbox_summary.md', 'utf8');

            console.log('Inbox processed successfully');
            console.log(summary);

            // Could send notifications here if needed

  email-integration:
    name: Email Integration Handler
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: Process email notifications
        run: |
          echo "ðŸ”” Email Integration System"
          echo "=========================="
          echo ""
          echo "This job handles email-based inbox management:"
          echo "- GitHub notification emails"
          echo "- External account emails"
          echo "- Automated responses"
          echo "- Email categorization"
          echo ""
          echo "Configuration required:"
          echo "1. Set up email forwarding to webhook endpoint"
          echo "2. Configure email API credentials in GitHub Secrets"
          echo "3. Define auto-reply templates in config/email-templates/"
          echo ""
          echo "For full setup instructions, see docs/INBOX_MANAGEMENT.md"

      - name: Generate email response templates
        run: |
          mkdir -p /tmp/email-templates

          cat > /tmp/email-templates/general-inquiry.txt <<'EOF'
          Subject: Re: {SUBJECT}

          Thank you for your email regarding the Avalon project!

          This is an automated response to let you know that your message has been received and categorized.

          **What happens next:**
          - Your message has been added to our inbox management system
          - A team member will review it within 24-48 hours
          - You'll receive a personal response soon

          **In the meantime:**
          - Check out our documentation: https://github.com/issdandavis/Avalon/tree/main/docs
          - Play the game: https://github.com/issdandavis/Avalon/blob/main/PLAY_THE_GAME.md
          - Join our community discussions

          Best regards,
          Avalon AI Inbox Management System

          ---
          This is an automated response. Please do not reply to this email.
          For urgent matters, visit: https://github.com/issdandavis/Avalon/issues
          EOF

          cat > /tmp/email-templates/bug-report.txt <<'EOF'
          Subject: Re: Bug Report - {SUBJECT}

          Thank you for reporting this bug!

          **Automated Bug Report Processing:**

          Your bug report has been received and logged in our system.

          **Next Steps:**
          1. A GitHub issue will be created automatically
          2. The development team will be notified
          3. You'll receive updates on the issue status

          **Issue Tracking:**
          - Priority: {PRIORITY}
          - Category: Bug Report
          - Expected Response: 24 hours

          **What we need from you:**
          Please ensure your report includes:
          - Steps to reproduce
          - Expected vs actual behavior
          - System information (browser, OS)
          - Screenshots if applicable

          You can track this issue at: {ISSUE_URL}

          Best regards,
          Avalon Development Team

          ---
          Automated Bug Report System
          EOF

          cat > /tmp/email-templates/collaboration-request.txt <<'EOF'
          Subject: Re: Collaboration Inquiry - {SUBJECT}

          Thank you for your interest in collaborating on the Avalon project!

          **Automated Response:**

          We're excited that you want to contribute! Your collaboration request has been received.

          **How to Get Started:**
          1. Review our Contributing Guide: https://github.com/issdandavis/Avalon/blob/main/CONTRIBUTING.md
          2. Check the Project Roadmap: https://github.com/issdandavis/Avalon/blob/main/docs/PROJECT_ROADMAP.md
          3. Join our discussions: https://github.com/issdandavis/Avalon/discussions

          **Collaboration Opportunities:**
          - Game content writing
          - ChoiceScript development
          - Testing and QA
          - Documentation
          - Artwork and design

          A maintainer will reach out within 48 hours to discuss specific opportunities.

          Looking forward to working with you!

          Best regards,
          Avalon Project Team

          ---
          Automated Collaboration System
          EOF

          echo "âœ… Email templates generated"
          ls -la /tmp/email-templates/

      - name: Upload email templates
        uses: actions/upload-artifact@v4
        with:
          name: email-templates-${{ github.run_number }}
          path: /tmp/email-templates/
          retention-days: 90

  multi-account-sync:
    name: Multi-Account Synchronization
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: Sync across Git accounts
        run: |
          echo "ðŸ”„ Multi-Account Git Synchronization"
          echo "===================================="
          echo ""
          echo "This job coordinates inbox management across multiple Git accounts:"
          echo ""
          echo "**Primary Account:** github.com/issdandavis/Avalon"
          echo "  - Status: Active âœ…"
          echo "  - Auto-reply: Enabled"
          echo "  - Categorization: Enabled"
          echo ""
          echo "**Additional Accounts (if configured):**"
          echo "  - GitLab (configure in secrets: GITLAB_TOKEN)"
          echo "  - Bitbucket (configure in secrets: BITBUCKET_TOKEN)"
          echo "  - Codeberg (configure in secrets: CODEBERG_TOKEN)"
          echo ""
          echo "**Synchronization Features:**
          echo "  âœ“ Unified inbox view"
          echo "  âœ“ Cross-platform issue tracking"
          echo "  âœ“ Automated status updates"
          echo "  âœ“ Consistent auto-replies"
          echo ""
          echo "To enable additional accounts, add credentials to GitHub Secrets"

      - name: Generate multi-account status
        run: |
          cat > /tmp/account_status.json << EOF
          {
            "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "accounts": {
              "github": {
                "username": "issdandavis",
                "repository": "Avalon",
                "status": "active",
                "inbox_managed": true,
                "auto_reply_enabled": true,
                "last_sync": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
              },
              "gitlab": {
                "configured": false,
                "status": "not_configured"
              },
              "bitbucket": {
                "configured": false,
                "status": "not_configured"
              }
            },
            "inbox_stats": {
              "total_managed_items": 0,
              "auto_replies_sent": 0,
              "categories_processed": 0
            }
          }
          EOF

          cat /tmp/account_status.json
          echo ""
          echo "âœ… Multi-account status generated"

      - name: Upload account status
        uses: actions/upload-artifact@v4
        with:
          name: multi-account-status-${{ github.run_number }}
          path: /tmp/account_status.json
          retention-days: 30
