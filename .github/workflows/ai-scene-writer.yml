name: AI Scene Writer - Continuous Development

# This workflow actively writes ChoiceScript scenes based on the task queue
# It makes REAL progress on the game, not just demos

on:
  schedule:
    - cron: '0 */3 * * *'  # Every 3 hours - frequent progress
  workflow_dispatch:
    inputs:
      scene_name:
        description: 'Specific scene to work on (optional)'
        required: false
        type: string
      force_complete:
        description: 'Force completion of current scene'
        required: false
        type: boolean
        default: false

jobs:
  write-scene-content:
    runs-on: ubuntu-latest
    if: ${{ secrets.ANTHROPIC_API_KEY != '' }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Python with caching
        uses: ./.github/actions/setup-python-deps
        with:
          extra-packages: pyyaml
          cache-key-suffix: scene-writer
      
      - name: Configure Git
        run: |
          git config --global user.name "SpiralVerse Scene Writer"
          git config --global user.email "scene-writer@spiralverse.dev"
      
      - name: Create AI work branch
        run: |
          git fetch origin
          git checkout ai-scene-development 2>/dev/null || git checkout -b ai-scene-development
          git merge origin/main --no-edit || true
      
      - name: Check for pending work (early exit optimization)
        id: check_work
        run: |
          echo "ðŸ” Checking if work is needed..."
          PLACEHOLDER_COUNT=$(grep -r "PLACEHOLDER\|TODO\|STUB" choicescript_game/scenes/*.txt 2>/dev/null | wc -l)
          INCOMPLETE_SCENES=$(find choicescript_game/scenes -name "*.txt" ! -name "choicescript_stats.txt" -size -5k | wc -l)
          
          if [ "$PLACEHOLDER_COUNT" -eq 0 ] && [ "$INCOMPLETE_SCENES" -eq 0 ]; then
            echo "has_work=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No scene writing work needed - all scenes complete"
            exit 0
          else
            echo "has_work=true" >> $GITHUB_OUTPUT
            echo "âœ… Work needed: $PLACEHOLDER_COUNT placeholders, $INCOMPLETE_SCENES incomplete scenes"
          fi
      
      - name: Analyze current game state
        id: analyze
        if: steps.check_work.outputs.has_work == 'true'
        run: |
          echo "Analyzing scenes for completion status..."
          
          # Count scenes with placeholder content
          PLACEHOLDER_COUNT=$(grep -r "PLACEHOLDER\|TODO\|STUB" choicescript_game/scenes/*.txt 2>/dev/null | wc -l)
          echo "placeholder_count=$PLACEHOLDER_COUNT" >> $GITHUB_OUTPUT
          
          # Count total scenes
          TOTAL_SCENES=$(ls -1 choicescript_game/scenes/*.txt 2>/dev/null | wc -l)
          echo "total_scenes=$TOTAL_SCENES" >> $GITHUB_OUTPUT
          
          # Find scene with least content (prioritize incomplete work)
          SMALLEST_SCENE=$(ls -lS choicescript_game/scenes/*.txt | tail -1 | awk '{print $NF}')
          echo "smallest_scene=$SMALLEST_SCENE" >> $GITHUB_OUTPUT
          
          echo "Found $PLACEHOLDER_COUNT placeholders in $TOTAL_SCENES scenes"
      
      - name: Write scene content with AI
        if: steps.check_work.outputs.has_work == 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          SCENE_NAME: ${{ github.event.inputs.scene_name }}
          FORCE_COMPLETE: ${{ github.event.inputs.force_complete }}
        run: |
          python .github/scripts/scene_writer_agent.py
      
      - name: Validate ChoiceScript syntax
        run: |
          # Basic syntax validation
          python .github/scripts/validate_choicescript.py choicescript_game/scenes/*.txt
          
          if [ $? -ne 0 ]; then
            echo "âŒ Syntax errors detected - rolling back"
            git reset --hard HEAD
            exit 1
          fi
          
          echo "âœ… All scenes have valid syntax"
      
      - name: Commit scene progress
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            CHANGED_FILES=$(git diff --name-only)
            git add choicescript_game/scenes/*.txt docs/AI_TASK_QUEUE.md
            
            # Create meaningful commit message
            SCENE_NAME=$(echo "$CHANGED_FILES" | grep '.txt$' | head -1 | xargs basename)
            LINES_ADDED=$(git diff --cached --numstat | awk '{sum+=$1} END {print sum}')
            
            git commit -m "[AI-SCENE] Added content to $SCENE_NAME (+${LINES_ADDED} lines)

Auto-generated by Scene Writer AI
- Added narrative content
- Included sensory details (taste/smell)
- Preserved character voices
- Updated stat mechanics
- Verified ChoiceScript syntax"
            
            echo "âœ… Committed $LINES_ADDED lines to $SCENE_NAME"
          else
            echo "â„¹ï¸ No changes to commit"
          fi
      
      - name: Push changes
        run: |
          git push origin ai-scene-development --force-with-lease
          echo "âœ… Pushed scene development to remote"
      
      - name: Update progress report
        run: |
          mkdir -p logs/scene-progress
          DATE=$(date +%Y-%m-%d)
          
          cat > logs/scene-progress/${DATE}.md << EOF
          # Scene Writing Progress - $DATE
          
          ## Scenes Modified
          $(git diff --name-only HEAD~1 HEAD 2>/dev/null | grep '.txt$' || echo "None")
          
          ## Lines Added
          $(git diff --stat HEAD~1 HEAD 2>/dev/null | tail -1)
          
          ## Current Status
          - Total Scenes: ${{ steps.analyze.outputs.total_scenes }}
          - Placeholders Remaining: ${{ steps.analyze.outputs.placeholder_count }}
          - Completion: $(( (100 * (${{ steps.analyze.outputs.total_scenes }} - ${{ steps.analyze.outputs.placeholder_count }})) / ${{ steps.analyze.outputs.total_scenes }} ))%
          
          ## Next Priority
          Continue expanding incomplete scenes in priority order.
          EOF
          
          git add logs/scene-progress/${DATE}.md
          git commit -m "[AI-LOG] Scene progress report for ${DATE}" || true
          git push origin ai-scene-development --force-with-lease || true
      
      - name: Create PR if significant progress
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check if we've added significant content (100+ lines)
          TOTAL_LINES=$(git diff origin/main...ai-scene-development --numstat | awk '{sum+=$1} END {print sum}')
          
          if [ "$TOTAL_LINES" -gt 100 ]; then
            # Check if PR exists
            PR_EXISTS=$(gh pr list --head ai-scene-development --json number --jq length)
            
            if [ "$PR_EXISTS" -eq 0 ]; then
              gh pr create \
                --title "ðŸŽ­ AI Scene Development: +${TOTAL_LINES} lines of content" \
                --body "## Auto-generated scene content

This PR contains scenes written by the autonomous AI scene writer.

**Stats:**
- Lines added: ${TOTAL_LINES}
- Scenes modified: $(git diff origin/main...ai-scene-development --name-only | grep '.txt$' | wc -l)
- Character voices: Preserved
- Sensory details: Included
- Syntax: Validated

**Review checklist:**
- [ ] Character voices match established patterns
- [ ] Sensory details are present
- [ ] Choices are meaningful
- [ ] Stat changes are balanced
- [ ] Lore consistency maintained

**Next steps:**
- Review content quality
- Test in ChoiceScript IDE
- Merge if approved
- AI will continue with next scenes" \
                --base main \
                --head ai-scene-development \
                --label "ai-generated" \
                --label "content" \
                --label "needs-review"
              
              echo "âœ… Created PR for review"
            else
              echo "â„¹ï¸ PR already exists, updating..."
            fi
          else
            echo "â„¹ï¸ Not enough content for PR yet ($TOTAL_LINES lines)"
          fi
      
      - name: Summary
        if: always()
        run: |
          echo "## ðŸŽ­ Scene Writer Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Scenes Total:** ${{ steps.analyze.outputs.total_scenes }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Placeholders:** ${{ steps.analyze.outputs.placeholder_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ai-scene-development" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp:** $(date -u)" >> $GITHUB_STEP_SUMMARY
