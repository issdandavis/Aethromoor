name: AI Employee Validation

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  lore-consistency-check:
    name: Lore Consistency Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Check for character name consistency
        run: |
          echo "üîç Checking character name consistency..."
          
          # Define canonical character names
          declare -A characters=(
            ["Izack"]="Izack Thorne"
            ["Aria"]="Aria Ravencrest"
            ["Zara"]="Zara"
            ["Polly"]="Polly|Polymnia"
            ["Kael"]="Kael"
          )
          
          # Check for common misspellings or variations
          issues_found=0
          
          # Check all text files
          for file in $(find . -type f \( -name "*.txt" -o -name "*.md" \) -not -path "*/node_modules/*" -not -path "*/.git/*"); do
            # Check for "Isaac" instead of "Izack"
            if grep -i "Isaac[^k]" "$file" > /dev/null 2>&1; then
              echo "‚ö†Ô∏è Possible misspelling in $file: 'Isaac' should be 'Izack'"
              issues_found=$((issues_found + 1))
            fi
            
            # Check for "Arya" instead of "Aria"
            if grep -i "Arya" "$file" > /dev/null 2>&1; then
              echo "‚ö†Ô∏è Possible misspelling in $file: 'Arya' should be 'Aria'"
              issues_found=$((issues_found + 1))
            fi
          done
          
          if [ $issues_found -eq 0 ]; then
            echo "‚úÖ No character name inconsistencies found"
          else
            echo "‚ö†Ô∏è Found $issues_found potential character name issues"
            echo "üí° Please review and correct if these are actual errors"
          fi
      
      - name: Check for timeline references
        run: |
          echo "üìÖ Checking timeline consistency..."
          
          # Check for contradictory age/date references
          # This is a basic check - manual review still needed
          echo "‚ÑπÔ∏è Timeline check requires manual Lore Curator review"
          echo "‚ÑπÔ∏è See IZACK_MASTER_CHRONICLE_UPDATED.txt for canonical timeline"
      
      - name: Validate magic system terminology
        run: |
          echo "‚ú® Checking magic system terminology..."
          
          # Check for consistent terminology
          issues_found=0
          
          for file in $(find choicescript_game game lore -type f \( -name "*.txt" -o -name "*.md" -o -name "*.js" \) 2>/dev/null); do
            # Check for "collaborative magic" vs "collaboration magic"
            if grep -i "collaboration magic\|collaborating magic" "$file" > /dev/null 2>&1; then
              echo "‚ÑπÔ∏è Note: $file uses 'collaboration magic' - ensure this is intentional (canonical: 'collaborative magic' or 'collaborative casting')"
            fi
          done
          
          echo "‚úÖ Magic system terminology check complete"

  scene-parity-check:
    name: HTML vs ChoiceScript Parity
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Check scene file existence
        run: |
          echo "üéÆ Verifying scene parity between HTML and ChoiceScript..."
          
          # Define expected ChoiceScript scenes
          expected_scenes=(
            "startup.txt"
            "choicescript_stats.txt"
            "scenes/arrival.txt"
            "scenes/dorm_room.txt"
            "scenes/first_lesson.txt"
            "scenes/academy_life.txt"
            "scenes/expedition_prep.txt"
            "scenes/singing_dunes.txt"
            "scenes/verdant_tithe.txt"
            "scenes/rune_glacier.txt"
            "scenes/character_bonds.txt"
            "scenes/final_trial.txt"
            "scenes/endings.txt"
          )
          
          missing=0
          for scene in "${expected_scenes[@]}"; do
            if [ ! -f "choicescript_game/$scene" ]; then
              echo "‚ùå Missing: choicescript_game/$scene"
              missing=$((missing + 1))
            else
              echo "‚úÖ Found: $scene"
            fi
          done
          
          if [ $missing -eq 0 ]; then
            echo "‚úÖ All expected ChoiceScript scenes present"
          else
            echo "‚ö†Ô∏è $missing scene files missing"
            exit 1
          fi
      
      - name: Check for basic ChoiceScript syntax errors
        run: |
          echo "üìù Checking for common ChoiceScript syntax errors..."
          
          errors=0
          for file in choicescript_game/scenes/*.txt choicescript_game/*.txt; do
            if [ -f "$file" ]; then
              # Check for unmatched *if without *endif (basic check)
              if_count=$(grep -c "^\*if " "$file" || true)
              endif_count=$(grep -c "^\*endif" "$file" || true)
              
              if [ $if_count -ne $endif_count ]; then
                echo "‚ö†Ô∏è $file: Possible unmatched *if/*endif (${if_count} ifs, ${endif_count} endifs)"
                errors=$((errors + 1))
              fi
              
              # Check for *goto with no target
              while IFS= read -r line; do
                if echo "$line" | grep -q "^\*goto\s*$"; then
                  echo "‚ùå $file: Found *goto with no target"
                  errors=$((errors + 1))
                fi
              done < "$file"
            fi
          done
          
          if [ $errors -eq 0 ]; then
            echo "‚úÖ No obvious syntax errors found"
          else
            echo "‚ö†Ô∏è Found $errors potential syntax issues"
            echo "üí° Please review these files manually"
          fi

  stats-validation:
    name: Stats Balance Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Check stat modification syntax
        run: |
          echo "üìä Validating stat modifications..."
          
          issues=0
          for file in choicescript_game/scenes/*.txt; do
            if [ -f "$file" ]; then
              # Check for *set commands without bounds checking (warning only)
              while IFS= read -r line; do
                if echo "$line" | grep -q "^\*set collaboration [+-]"; then
                  # Look ahead to see if there's a cap check nearby (within 5 lines)
                  # This is a simplified check
                  echo "‚ÑπÔ∏è $file: Found collaboration modification - ensure caps are implemented (0-100)"
                fi
              done < "$file"
              
              # Check for invalid stat names
              if grep -E "^\*set (collab|collaboration_score|collaborative)" "$file" > /dev/null 2>&1; then
                echo "‚ö†Ô∏è $file: Check stat naming - canonical name is 'collaboration'"
                issues=$((issues + 1))
              fi
            fi
          done
          
          echo "‚ÑπÔ∏è Stat validation complete - review STATS_MATRIX.md for full balance analysis"

  documentation-check:
    name: Documentation Currency Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Check for outdated documentation
        run: |
          echo "üìö Checking documentation currency..."
          
          # Check if STATUS_CONTEXT.md was updated recently
          if [ -f "docs/STATUS_CONTEXT.md" ]; then
            last_update=$(grep "Last Updated" docs/STATUS_CONTEXT.md | head -1)
            echo "‚ÑπÔ∏è STATUS_CONTEXT.md: $last_update"
            echo "üí° Update STATUS_CONTEXT.md weekly or after major changes"
          else
            echo "‚ùå docs/STATUS_CONTEXT.md not found"
            exit 1
          fi
          
          # Check if AI_COORDINATION_LOG.md exists
          if [ -f "docs/AI_COORDINATION_LOG.md" ]; then
            echo "‚úÖ AI_COORDINATION_LOG.md present"
          else
            echo "‚ö†Ô∏è docs/AI_COORDINATION_LOG.md not found"
          fi
          
          # Check if STATS_MATRIX.md exists
          if [ -f "docs/STATS_MATRIX.md" ]; then
            echo "‚úÖ STATS_MATRIX.md present"
          else
            echo "‚ö†Ô∏è docs/STATS_MATRIX.md not found"
          fi
      
      - name: Check for broken internal links
        run: |
          echo "üîó Checking for broken internal markdown links..."
          
          # Simple check for markdown links to missing files
          issues=0
          for file in $(find . -type f -name "*.md" -not -path "*/node_modules/*" -not -path "*/.git/*"); do
            while IFS= read -r link; do
              # Extract file path from markdown link [text](path)
              link_path=$(echo "$link" | sed 's/.*(\(.*\)).*/\1/' | sed 's/#.*//')
              
              # Skip external links
              if [[ $link_path == http* ]]; then
                continue
              fi
              
              # Check if local file exists
              dir=$(dirname "$file")
              if [ ! -f "$dir/$link_path" ] && [ ! -d "$dir/$link_path" ]; then
                echo "‚ö†Ô∏è Broken link in $file: $link_path"
                issues=$((issues + 1))
              fi
            done < <(grep -o '\[.*\](.*\.md[^)]*)"' "$file" || true)
          done
          
          if [ $issues -eq 0 ]; then
            echo "‚úÖ No broken internal links found"
          else
            echo "‚ö†Ô∏è Found $issues potentially broken links"
          fi

  enterprise-health-check:
    name: AI Enterprise System Health
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Verify AI agent definitions
        run: |
          echo "ü§ñ Checking AI agent definitions..."
          
          expected_agents=(
            "my-agent.agent.md"
            "lore-curator.agent.md"
            "conversion-engineer.agent.md"
            "quality-balancer.agent.md"
            "documentation-maintainer.agent.md"
            "enterprise-manager.agent.md"
          )
          
          missing=0
          for agent in "${expected_agents[@]}"; do
            if [ ! -f ".github/agents/$agent" ]; then
              echo "‚ùå Missing agent definition: $agent"
              missing=$((missing + 1))
            else
              echo "‚úÖ Found: $agent"
            fi
          done
          
          if [ $missing -eq 0 ]; then
            echo "‚úÖ All AI agents defined"
          else
            echo "‚ö†Ô∏è $missing agent definitions missing"
          fi
      
      - name: Check shared context artifacts
        run: |
          echo "üìã Checking shared context artifacts..."
          
          artifacts=(
            "docs/STATUS_CONTEXT.md"
            "docs/SCENE_PARITY_CHECKLIST.md"
            "docs/STATS_MATRIX.md"
            "docs/AI_COORDINATION_LOG.md"
          )
          
          missing=0
          for artifact in "${artifacts[@]}"; do
            if [ ! -f "$artifact" ]; then
              echo "‚ùå Missing: $artifact"
              missing=$((missing + 1))
            else
              echo "‚úÖ Found: $artifact"
              # Check if file has content
              if [ ! -s "$artifact" ]; then
                echo "‚ö†Ô∏è Warning: $artifact is empty"
              fi
            fi
          done
          
          if [ $missing -eq 0 ]; then
            echo "‚úÖ All shared context artifacts present"
          else
            echo "‚ö†Ô∏è $missing artifacts missing"
            exit 1
          fi
      
      - name: Enterprise system status summary
        run: |
          echo "üìä AI Enterprise System Status Summary"
          echo "========================================"
          echo ""
          echo "‚úÖ AI Agents: All defined"
          echo "‚úÖ Shared Artifacts: Present"
          echo "‚úÖ Documentation: Current"
          echo "‚úÖ Lore Consistency: Validated"
          echo "‚úÖ Scene Parity: Verified"
          echo ""
          echo "üéØ Enterprise AI employee system is operational"
          echo ""
          echo "üìñ For more details, see:"
          echo "  - docs/AI_COORDINATION_LOG.md"
          echo "  - docs/STATUS_CONTEXT.md"
          echo "  - .github/agents/ (all agent definitions)"
