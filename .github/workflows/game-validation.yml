name: Game Validation

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'game/**'
      - 'choicescript_game/**'
  pull_request:
    branches: [ main, develop ]

jobs:
  validate-html-game:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Validate HTML
        run: |
          echo "Checking for broken links in index.html..."
          if grep -q 'src=""' game/index.html; then
            echo "ERROR: Empty src attributes found"
            exit 1
          fi
          echo "✓ HTML validation passed"
      
      - name: Validate JavaScript
        run: |
          echo "Checking game.js syntax..."
          if ! node -c game/game.js; then
            echo "ERROR: JavaScript syntax errors found"
            exit 1
          fi
          echo "✓ JavaScript validation passed"
      
      - name: Check for duplicate story nodes
        run: |
          echo "Checking for duplicate story node keys..."
          grep -o "^[[:space:]]*[a-zA-Z_][a-zA-Z0-9_]*:" game/game.js | sort | uniq -d > /tmp/duplicates.txt
          if [ -s /tmp/duplicates.txt ]; then
            echo "ERROR: Duplicate story nodes found:"
            cat /tmp/duplicates.txt
            exit 1
          fi
          echo "✓ No duplicate nodes found"

  validate-choicescript:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Check ChoiceScript scene files
        run: |
          echo "Validating ChoiceScript scenes..."
          for file in choicescript_game/scenes/*.txt; do
            if [ -f "$file" ]; then
              echo "Checking $file..."
              # Check for common ChoiceScript errors
              if grep -q '\*goto[[:space:]]*$' "$file"; then
                echo "ERROR: *goto without destination in $file"
                exit 1
              fi
            fi
          done
          echo "✓ ChoiceScript validation passed"

  check-file-sizes:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Check for large files
        run: |
          echo "Checking for files larger than 5MB..."
          large_files=$(find . -type f -size +5M -not -path "./.git/*" || true)
          if [ -n "$large_files" ]; then
            echo "WARNING: Large files found:"
            echo "$large_files"
            echo "Consider using Git LFS or archiving these files"
          else
            echo "✓ No large files found"
          fi

  notify-discord:
    runs-on: ubuntu-latest
    needs: [validate-html-game, validate-choicescript]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Send Discord notification
        run: |
          echo "Discord webhook would notify here about successful game validation"
          echo "Set DISCORD_WEBHOOK_URL secret to enable notifications"
